# 实施计划: macOS系统监控

## 概述

使用Swift和AppKit开发macOS菜单栏系统监控应用。采用模块化架构，逐步实现数据收集、UI显示和用户设置功能。每个任务都建立在前面的基础上，确保增量进展和早期功能验证。

## 任务

- [x] 1. 设置项目结构和核心接口
  - 创建Xcode项目和目录结构
  - 定义核心数据模型和协议接口
  - 配置测试框架（XCTest + swift-check）
  - 设置应用为菜单栏专用应用（LSUIElement = true）
  - _需求: 1.1, 1.5_

- [x] 1.1 编写数据模型的基础属性测试
  - **属性 1: 状态项数据显示**
  - **验证: 需求 1.2**

- [x] 2. 实现基础系统监控功能
  - [x] 2.1 实现CPUMonitor类
    - 使用host_processor_info()获取CPU使用率
    - 通过sysctl获取CPU频率和核心数
    - _需求: 2.2_

  - [ ] 2.2 编写CPU监控的属性测试
    - **属性 2: 数据更新频率**
    - **验证: 需求 1.3, 2.2**

  - [x] 2.3 实现MemoryMonitor类
    - 使用host_statistics()获取内存统计
    - 计算内存压力状态
    - _需求: 2.4_

  - [x] 2.4 编写内存监控的单元测试
    - 测试内存数据收集的边界情况
    - 测试内存压力状态计算
    - _需求: 2.4_

- [x] 3. 实现菜单栏状态项
  - [x] 3.1 创建StatusBarManager类
    - 设置NSStatusItem和基础显示
    - 实现状态项的点击处理
    - _需求: 1.1, 2.1_

  - [x] 3.2 实现状态项数据显示
    - 显示CPU使用率百分比
    - 实现数据更新机制
    - _需求: 1.2, 1.3_

  - [x] 3.3 编写CPU警告状态的属性测试
    - **属性 3: CPU警告状态指示**
    - **验证: 需求 1.4**

- [x] 4. 检查点 - 确保基础功能正常
  - 确保所有测试通过，如有问题请询问用户

- [x] 5. 实现下拉菜单系统
  - [x] 5.1 创建MenuBuilder类
    - 构建包含系统信息的下拉菜单
    - 实现菜单项的动态更新
    - _需求: 2.1, 2.2, 2.3, 2.4_

  - [x] 5.2 编写菜单内容完整性的属性测试
    - **属性 4: 菜单内容完整性**
    - **验证: 需求 2.2, 2.3, 2.4, 2.5, 2.6, 2.7**

  - [x] 5.3 添加基础菜单项（偏好设置、关于、退出）
    - 实现菜单项的点击处理
    - _需求: 3.1, 5.1, 5.3_

- [x] 6. 扩展系统监控功能
  - [x] 6.1 实现GPUMonitor类
    - 使用powermetrics获取GPU使用率
    - 支持Apple Silicon和Intel GPU
    - _需求: 2.3_

  - [x] 6.2 实现TemperatureMonitor类
    - 使用SMC API或powermetrics获取温度
    - 处理不同硬件的兼容性
    - _需求: 2.6_

  - [x] 6.3 实现NetworkMonitor类
    - 使用getifaddrs()获取网络统计
    - 计算实时上传/下载速度
    - _需求: 2.7_

  - [x] 6.4 实现DiskMonitor类
   NSFileManager获取磁盘空间
    - 通过IOKit监控读写速度
    - _需求: 2.5_

- [x] 7. 实现偏好设置系统
  - [x] 7.1 创建PreferencesManager类
    - 实现设置的保存和加载
    - 使用UserDefaults存储配置
    - _需求: 3.2, 3.6_

  - [x] 7.2 创建偏好设置窗口
    - 实现显示选项选择器
    - 添加更新频率滑块（1-10秒）
    - 添加警告阈值设置
    - _需求: 3.3, 3.4, 3.5_

  - [x] 7.3 编写设置窗口功能的属性测试
    - **属性 5: 设置窗口功能完整性**
    - **验证: 需求 3.3, 3.4, 3.5**

  - [x] 7.4 实现设置立即应用功能
    - 监听设置变更并立即生效
    - _需求: 3.6_

  - [x] 7.5 编写设置立即应用的属性测试
    - **属性 6: 设置立即应用**
    - **验证: 需求 3.6**

- [x] 8. 实现性能优化和错误处理
  - [x] 8.1 实现异步数据收集
    - 所有监控操作在后台队列执行
    - 避免阻塞主线程
    - _需求: 4.1, 4.2_

  - [x] 8.2 实现系统事件处理
    - 处理系统睡眠和唤醒事件
    - 在睡眠时暂停监控，唤醒时恢复
    - _需求: 4.3, 4.4_

  - [x] 8.3 编写睡眠唤醒处理的属性测试
    - **属性 8: 睡眠唤醒往返**
    - **验证: 需求 4.3, 4.4**

  - [x] 8.4 实现错误处理机制
    - 权限不足时显示友好提示
    - 数据获取失败时显示"N/A"
    - 记录错误到系统日志
    - _需求: 4.5, 6.1, 6.2, 6.3, 6.4_

  - [x] 8.5 编写错误处理的属性测试
    - **属性 9: 错误优雅处理**
    - **属性 10: 日志记录一致性**
    - **验证: 需求 4.5, 6.1, 6.2, 6.3, 6.4**

- [x] 9. 性能验证和优化
  - [x] 9.1 实现性能监控
    - 监控应用自身的CPU和内存使用
    - 实现性能限制检查
    - _需求: 4.1, 4.2_

  - [ ] 9.2 编写性能限制的属性测试
    - **属性 7: 性能资源限制**
    - **验证: 需求 4.1, 4.2**

  - [x] 9.3 优化数据收集频率
    - 根据系统负载调整更新间隔
    - 实现智能缓存策略
    - _需求: 4.1, 4.2_

- [x] 10. 最终集成和完善
  - [x] 10.1 集成所有监控模块
    - 将所有监控器集成到SystemMonitor中
    - 实现统一的数据收集协调
    - _需求: 所有需求_

  - [x] 10.2 完善用户界面
    - 优化菜单布局和显示
    - 添加右键菜单支持
    - _需求: 5.4_

  - [ ] 10.3 编写集成测试
    - 测试完整的用户交互流程
    - 测试长时间运行稳定性
    - _需求: 所有需求_

  - [x] 10.4 添加应用管理功能
    - 实现退出功能
    - 添加关于窗口
    - 可选的自动重启功能
    - _需求: 5.2, 5.3, 5.5_

- [ ] 11. 完善属性测试覆盖
  - [ ] 11.1 编写剩余的属性测试
    - 实现所有设计文档中定义的正确性属性
    - 确保每个属性测试运行至少100次迭代
    - _需求: 所有需求_

  - [ ] 11.2 编写单元测试补充
    - 为扩展监控功能添加单元测试
    - 测试错误处理边界情况
    - _需求: 2.3, 2.5, 2.6, 2.7, 4.5, 6.1-6.4_

- [ ] 12. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以实现更快的MVP
- 每个任务都引用特定需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况